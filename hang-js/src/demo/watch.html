<!doctype html>
<html lang="en" class="sl-theme-dark dark">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MoQ Demo</title>

	<!-- Use shoelace for some basic UI elements. -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/dark.css" />
	<script type="module"
		src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/shoelace-autoloader.js"></script>
</head>

<body class="prose dark:prose-invert lg:prose-xl max-w-none p-8">
	<div id="container">
		<!-- Include the custom element to set up the canvas. -->
		<hang-watch url="http://localhost:4443/demo/bbb" id="watch">
			<!-- Optionally provide a custom canvas element that we can style as needed -->
			<canvas style="max-width: 100%; height: auto; border-radius: 4px;"></canvas>
		</hang-watch>

		<!-- Make some simple controls to demonstate the API. -->
		<div style="justify-content: space-between; align-items: center; margin: 8px 0; gap: 8px; display: flex;">
			<div style="display: flex; gap: 8px;">
				<sl-button id="pause">
					<sl-icon name="pause" label="Pause" />
				</sl-button>

				<sl-dropdown placement="top-start" distance={2} hoist>
					<sl-button slot="trigger">
						<sl-icon name="volume-up" label="Volume" />
					</sl-button>

					<sl-menu>
						<sl-menu-item>
							<sl-range tooltip="none" id="volume" label="Volume" min=0 max=1 step=0.01 />
						</sl-menu-item>
					</sl-menu>
				</sl-dropdown>
			</div>

			<div style="display: flex; align-items: center; gap: 8px;">
				<sl-spinner id="spinner"></sl-spinner>
				<span id="status">Initializing...</span>
			</div>

			<div style="display: flex; gap: 8px;">
				<sl-button id="fullscreen">
					<sl-icon name="fullscreen" label="Fullscreen" />
				</sl-button>
			</div>
		</div>
	</div>

	<h3>Tips:</h3>
	<p>
		Click the video to enable audio.
		This is not always necessary, but sometimes browsers require user interaction before autoplaying
		audio. If using the library directly, call <code class="language-typescript">watch.audio.init()</code> to try
		to reinitialize audio.
	</p>
	<p>
		You can use CSS to change the size of the canvas.
		Unfortunately, you can't use the HTML width/height attributes because of <a
			href="https://developer.mozilla.org/en-US/docs/Web/API/OffscreenCanvas">OffscreenCanvas</a>
		limitation.

		For example:
	<pre><code class="language-html">&lt;hang-watch url=&quot;http://localhost:4443/demo/bbb&quot;&gt;
	&lt;!-- Optionally provide a custom canvas element that we can style as needed --&gt;
	&lt;canvas style=&quot;max-width: 100%; height: auto; border-radius: 4px;&quot;&gt;&lt;/canvas&gt;
&lt;/hang-watch&gt;</code></pre>
	</p>
	<p>
		Media only flows over the network when needed!
		Video won't be downloaded when minimized/paused and audio won't be downloaded when muted or disabled.
		This extends to publishing as well, the client won't push media until at least 1 viewer wants it.
	</p>
	<p>
		You can instanciate the player via the provided <code class="language-html">&lt;hang-watch&gt;</code> <a
			href="https://developer.mozilla.org/en-US/docs/Web/API/Web_components">Web Component</a>.
		Either modify HTML attributes like <code class="language-html">&lt;moq-watch paused&gt;</code>
		or access the element's Javascript API:
	<pre><code class="language-typescript">const watch = document.getElementById("watch");
watch.lib.paused = true;
</code></pre>
	And of course you can use the Javascript API directly instead of the Web Component.
	<pre><code class="language-typescript">import { Watch } from "@kixelated/moq";

// Create a new player instance.
const watch = new Watch();

// Have to provide your own canvas element.
watch.canvas = document.querySelector("canvas")[0];

// And of course set the URL to start loading.
watch.url = "http://localhost:4443/demo/bbb";</code></pre>
	</p>
	<p>
		This demo supports query parameters to change the broadcast.
		Try running <code class="language-bash">just pub tos</code> in a new terminal and then <a
			href="?broadcast=demo/tos" target="_blank">watch the
			inferior test video</a>. The player also support automatically reloading broadcasts.
		Try running multiple terminals and kill the broadcast to see what happens.

	<pre><code class="language-bash"># Run the relay and web server in another terminal or the background.
just relay &
just web &

just pub bbb
# Kill it with ctrl+C

# Republish the same broadcast, the player will reconnect.
just pub bbb
		</code></pre>
	</p>

	<h3>Other demos:</h3>
	<ul>
		<li><a href="publish.html">Publish a webcam or window.</a></li>
	</ul>
</body>

<script>
	// Yes this is a terrible mess and not how we make websites in >current year<.
	// But it's a demo, I'm lazy, and I don't want to require a build step.
	const watch = document.getElementById("watch");
	const pause = document.getElementById("pause");
	const fullscreen = document.getElementById("fullscreen");
	const spinner = document.getElementById("spinner");
	const status = document.getElementById("status");
	const volume = document.getElementById("volume");
	const container = document.getElementById("container");

	// If query params are provided, use them as the broadcast URL instead of the default.
	const urlParams = new URLSearchParams(window.location.search);
	if (urlParams.size > 0) {
		const broadcast = urlParams.get("broadcast") ?? "demo/bbb";
		const host = urlParams.get("host") ?? "localhost:4443";
		const scheme = urlParams.get("scheme") ?? "http";
		watch.setAttribute("url", `${scheme}://${host}/${broadcast}`);
	}

	// Listen for clicks on the pause button.
	pause.addEventListener("click", () => {
		watch.lib.video.paused = !watch.lib.video.paused;
	});

	// Listen for clicks on the fullscreen button.
	let fullscreenActive = false;
	fullscreen.addEventListener("click", () => {
		if (fullscreenActive) {
			document.exitFullscreen();
		} else {
			container.requestFullscreen();
		}

		fullscreenActive = !fullscreenActive;
	});

	// Set the volume to 50% by default.
	volume.value = 0.50;

	// Listen for changes to the volume input.
	volume.addEventListener("sl-input", () => {
		watch.lib.volume = Number.parseFloat(volume.value);
	});

	// Listen for connection status changes.
	watch.addEventListener("hang-watch-status", (event) => {
		if (event.detail === "connected") {
			status.textContent = "Connected";
			spinner.style.display = "none";
		} else if (event.detail === "connecting") {
			status.textContent = "Connecting...";
			spinner.style.display = "block";
		} else if (event.detail === "disconnected") {
			status.textContent = "Disconnected";
			spinner.style.display = "none";
		} else if (event.detail === "live") {
			status.textContent = "Live";
			spinner.style.display = "none";
		} else if (event.detail === "offline") {
			status.textContent = "Offline";
			spinner.style.display = "none";
		} else {
			throw new Error(`Unknown connection status: ${event.detail}`);
		}
	});
</script>

</html>